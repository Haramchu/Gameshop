{% extends 'base.html' %}

{% block content %}

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand" href="#">Store Page</a>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item ml-auto">
                <a class="nav-link" href="{% url 'main:logout' %}">
                    Logout
                </a>
            </li>
        </ul>
    </div>
</nav>

<style>
    body {
        background-image: url('https://wallpaperaccess.com/full/2109.jpg');
        background-size: cover;
    }

    h5 {
        color: rgb(255, 255, 255);
    }

    h2 {
        color: rgb(255, 255, 255);
    }

    #white {
        color: rgb(255, 255, 255);
    }

    table {
        border-collapse: collapse;
        margin: 20px auto;
        width: 100%;
    }

    table tbody tr:last-child {
        background-color: rgb(76, 0, 0);
    }

    th {
        background-color: black;
        color: white;
        text-align: center;
        border: 1px solid #ddd;
        padding: 8px;
        font-size: 20px;
    }

    td {
        text-align: center;
        border: 1px solid #ddd;
        padding: 8px;
        font-size: 20px;
        color: white;
    }

    tr:nth-child(even) {
        background-color: #474747
    }

    tr:nth-child(odd) {
        background-color: rgb(39, 39, 39);
    }

    button {
        width: 80px;
        height: 30px;
        text-align: center;
        display: block;
        margin: 0 auto;
        margin-bottom: 10px;
    }

    #button_navbar {
        margin-left: 10%;
        margin: 0;
    }

    #text_navbar {
        margin-right: 10%;
        margin: 0;
    }

    #button_besar {
        width: 200px;
        height: 30px;
        text-align: center;
        display: block;
        margin: 0 auto;
        margin-bottom: 10px;
    }

    #align_center {
        text-align: center;
    }

    #small_text {
        font-size: 16px;
    }
</style>
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Add New Game</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form" onsubmit="return false;">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="name" class="col-form-label">Name:</label>
                        <input type="text" class="form-control" id="name" name="name"></input>
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="col-form-label">Amount:</label>
                        <input type="text" class="form-control" id="amount" name="amount"></input>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="col-form-label">Price:</label>
                        <input type="number" class="form-control" id="price" name="price"></input>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="col-form-label">Description:</label>
                        <textarea class="form-control" id="description" name="description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="button_add" data-bs-dismiss="modal">Add
                    Game</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="confirmationModalLabel">Delete Confirmation</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p color="black">Are you sure you want to remove this game from your library?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete" data-bs-dismiss="modal">Remove</button>
            </div>
        </div>
    </div>
</div>
<div class="container mt-4">
    <br />
    <h2 id="align_center">{{appname}}</h2>

    <h5>Name:</h5>
    <p id="white">{{name}}</p>

    <h5>Class:</h5>
    <p id="white">{{class}}</p>

    <h5>Different Games Owned:</h5>
    <p id="white">{{product_count}}</p>

    <h5>Last Login:</h5>
    <p id="white">{{last_login}}</p>

    <h2 id="align_center">Game List</h2>

    <table class="tg">
        <thead>
            <tr>
                <th class="tg-0lax">Name</th>
                <th class="tg-0lax">Image</th>
                <th class="tg-0lax">Release Date</th>
                <th class="tg-0lax">Price</th>
                <th class="tg-0lax">Reviews</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="tg-0lax">Monster Hunter World</td>
                <td class="tg-0lax"><img
                        src="https://ecs7.tokopedia.net/blog-tokopedia-com/uploads/2018/06/Monster-Hunter-World.jpg"
                        width="192" height="108" /></td>
                <td class="tg-0lax">9 August, 2018</td>
                <td class="tg-0lax">Rp 335.000,00</td>
                <td class="tg-0lax">Very positive</td>
            </tr>
            <tr>
                <td class="tg-0lax">Armored Core VI Fires of Rubicon</td>
                <td class="tg-0lax"><img
                        src="https://static.bandainamcoent.eu/high/armored-core/armored-core-vi-fires-of-rubicon/00-page-setup/acvifor-header-mobile-new.jpg"
                        width="192" height="108" /></td>
                <td class="tg-0lax">25 August, 2023</td>
                <td class="tg-0lax">Rp 600.000,00</td>
                <td class="tg-0lax">Very positive</td>
            </tr>
            <tr>
                <td class="tg-0lax">Dota 2</td>
                <td class="tg-0lax"><img src="https://cdn.cloudflare.steamstatic.com/apps/dota2/images/dota2_social.jpg"
                        width="192" height="108" /></td>
                <td class="tg-0lax">9 Juli, 2012</td>
                <td class="tg-0lax">Free</td>
                <td class="tg-0lax">Very positive</td>
            </tr>
        </tbody>
    </table>
    <br />
    <h2 id="align_center">Shopping Cart</h2>
    <table id="product_table"> </table>

    <br />
    <a>
        <button id="button_besar" type="button" class="btn btn-primary" data-bs-toggle="modal"
            data-bs-target="#exampleModal">Add Product by AJAX</button>
    </a>
</div>
<script>
    async function getProducts() {
        return fetch("{% url 'main:get_product_json' %}").then((res) => res.json())
    }
    async function refreshProducts() {
        document.getElementById("product_table").innerHTML = ""
        const products = await getProducts()
        let htmlString = `<tr>
                <th>Name</th>
                <th>Amount</th>
                <th>Price</th>
                <th>Description</th>
                <th>Date Added</th>
                <th>Add/Sub</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>`
        products.forEach((item) => {
            htmlString += `\n
            <div class="col-md-4">
            <div class="card product-card">
            <tr>
                <td>${item.fields.name}</td>
                <td>${item.fields.amount}</td>
                <td>${item.fields.price}</td>
                <td>${item.fields.description}</td>
                <td>${item.fields.date_added}</td>
                <td>
                    <a href="add_amount/${item.pk}">
                        <button>
                            Add
                        </button>
                    </a>
                    <a href="sub_amount/${item.pk}">
                        <button>
                            Sub
                        </button>
                    </a>
                </td>
                <td>
                    <a href="edit-product/${item.pk}">
                        <button>
                            Edit
                        </button>
                    </a>
                </td>
                <td>
                    <button type="button" onclick="showConfirmationModal(${item.pk})">Delete</button>
                </td>
            </tr>
            </div>
            </div>`
        })
        document.getElementById("product_table").innerHTML = htmlString
    }
    refreshProducts()
    function addProduct() {
        fetch("{% url 'main:add_product_ajax' %}", {
            method: "POST",
            body: new FormData(document.querySelector('#form'))
        }).then(refreshProducts)

        document.getElementById("form").reset()
        return false
    }
    document.getElementById("button_add").onclick = addProduct
    async function deleteProduct(productId) {
        fetch(`{% url 'main:delete_product_ajax' 0 %}`.replace('0', productId), {
            method: "POST"
        })
            .then((response) => {
                if (response.ok) {
                    refreshProducts();
                } else {
                    alert("Delete failed. Please try again.");
                }
            })
            .catch((error) => {
                console.error("Error while deleting product:", error);
                alert("Delete failed. Please try again.");
            });
    }

    function showConfirmationModal(productId) {
        document.getElementById("confirmDelete").setAttribute("data-product-id", productId);

        document.getElementById("confirmDelete").addEventListener("click", function () {
            const productId = this.getAttribute("data-product-id");
            deleteProduct(productId);
        });

        const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        confirmationModal.show();
    }
</script>
{% endblock content %}